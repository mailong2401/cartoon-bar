#!/bin/bash

echo "ğŸ–¥ï¸  THÃ”NG TIN CHI TIáº¾T CPU"

# =========================================
# 1. THÃ”NG TIN PHáº¦N Cá»¨NG CPU
# =========================================
echo
echo "ğŸ“‹ THÃ”NG TIN PHáº¦N Cá»¨NG:"

# CPU Model vÃ  architecture
if [ -f /proc/cpuinfo ]; then
  echo "ğŸ”¹ Model: $(grep "model name" /proc/cpuinfo | head -1 | cut -d':' -f2 | sed 's/^ *//')"
  echo "ğŸ”¹ Vendor: $(grep "vendor_id" /proc/cpuinfo | head -1 | cut -d':' -f2 | sed 's/^ *//')"
  echo "ğŸ”¹ Architecture: $(uname -m)"
  echo "ğŸ”¹ Sá»‘ sockets: $(lscpu 2>/dev/null | grep "Socket(s):" | awk '{print $2}' || echo "N/A")"
  echo "ğŸ”¹ Sá»‘ cores: $(nproc)"
  echo "ğŸ”¹ Sá»‘ threads: $(grep -c "processor" /proc/cpuinfo)"
  echo "ğŸ”¹ CPU MHz: $(grep "cpu MHz" /proc/cpuinfo | head -1 | awk '{print $4}')"
  echo "ğŸ”¹ Cache L1d: $(lscpu 2>/dev/null | grep "L1d cache" | awk -F':' '{print $2}' | sed 's/^ *//' || echo "N/A")"
  echo "ğŸ”¹ Cache L2: $(lscpu 2>/dev/null | grep "L2 cache" | awk -F':' '{print $2}' | sed 's/^ *//' || echo "N/A")"
  echo "ğŸ”¹ Cache L3: $(lscpu 2>/dev/null | grep "L3 cache" | awk -F':' '{print $2}' | sed 's/^ *//' || echo "N/A")"
fi

# =========================================
# 2. Sá»¬ Dá»¤NG CPU THEO THá»œI GIAN THá»°C
# =========================================
echo
echo "ğŸ“ˆ Sá»¬ Dá»¤NG CPU HIá»†N Táº I:"

# Láº¥y thÃ´ng tin CPU tá»« /proc/stat
get_cpu_usage() {
  cpu_line=$(grep "^cpu " /proc/stat)
  user=$(echo $cpu_line | awk '{print $2}')
  nice=$(echo $cpu_line | awk '{print $3}')
  system=$(echo $cpu_line | awk '{print $4}')
  idle=$(echo $cpu_line | awk '{print $5}')
  iowait=$(echo $cpu_line | awk '{print $6}')
  irq=$(echo $cpu_line | awk '{print $7}')
  softirq=$(echo $cpu_line | awk '{print $8}')
  steal=$(echo $cpu_line | awk '{print $9}')
  guest=$(echo $cpu_line | awk '{print $10}')

  total=$((user + nice + system + idle + iowait + irq + softirq + steal + guest))
  idle_total=$((idle + iowait))
  usage=$((100 - (idle_total * 100) / total))

  echo "ğŸ”¹ Tá»•ng usage: ${usage}%"
  echo "ğŸ”¹ User: $((user * 100 / total))%"
  echo "ğŸ”¹ System: $((system * 100 / total))%"
  echo "ğŸ”¹ Idle: $((idle_total * 100 / total))%"
  echo "ğŸ”¹ I/O Wait: $((iowait * 100 / total))%"
}

get_cpu_usage

# =========================================
# 3. Sá»¬ Dá»¤NG THEO Tá»ªNG CORE
# =========================================
echo
echo "ğŸ”¢ Sá»¬ Dá»¤NG THEO Tá»ªNG CORE:"

if command -v mpstat &>/dev/null; then
  mpstat -P ALL 1 1 | tail -n +4 | while read line; do
    if [ -n "$line" ]; then
      cpu_num=$(echo $line | awk '{print $2}')
      usage=$(echo $line | awk '{printf "%.1f", 100-$12}')
      if [ "$cpu_num" == "all" ]; then
        echo "ğŸ”¸ Táº¥t cáº£ cores: ${usage}%"
      else
        echo "ğŸ”¸ Core $cpu_num: ${usage}%"
      fi
    fi
  done
else
  echo "âš ï¸  CÃ i mpstat: sudo apt install sysstat"

  # Fallback: Ä‘á»c tá»« /proc/stat
  core_count=$(grep -c "^cpu[0-9]" /proc/stat)
  echo "ğŸ”¸ Tá»•ng sá»‘ cores: $core_count"
  for i in $(seq 0 $((core_count - 1))); do
    echo "ğŸ”¸ Core $i: Äang theo dÃµi..."
  done
fi

# =========================================
# 4. LOAD AVERAGE VÃ€ PROCESS
# =========================================
echo
echo "ğŸ“Š LOAD AVERAGE & PROCESS:"

load_avg=$(uptime | awk -F'load average:' '{print $2}')
echo "ğŸ”¹ Load Average: $load_avg"

# Giáº£i thÃ­ch load average
load1=$(echo $load_avg | awk -F',' '{print $1}')
cores=$(nproc)
load_per_core=$(echo "scale=2; $load1 / $cores" | bc)

echo "ğŸ”¹ Load/Core: $load_per_core"
if (($(echo "$load_per_core < 1.0" | bc -l))); then
  echo "ğŸ”¹ Tráº¡ng thÃ¡i: âœ… BÃ¬nh thÆ°á»ng"
elif (($(echo "$load_per_core < 2.0" | bc -l))); then
  echo "ğŸ”¹ Tráº¡ng thÃ¡i: âš ï¸  Táº£i trung bÃ¬nh"
else
  echo "ğŸ”¹ Tráº¡ng thÃ¡i: ğŸ”´ Táº£i cao"
fi

# =========================================
# 5. TOP PROCESS Sá»¬ Dá»¤NG CPU
# =========================================
echo
echo "ğŸ”¥ TOP 10 PROCESS Sá»¬ Dá»¤NG CPU NHIá»€U NHáº¤T:"

printf "%-12s %-8s %-8s %-12s %-s\n" "USER" "PID" "%CPU" "MEMORY" "COMMAND"
ps aux --sort=-%cpu | head -11 | tail -10 | while read user pid cpu mem vsz rss tty stat start time command; do
  if [ "$pid" != "PID" ]; then
    printf "%-12s %-8s %-8s %-12s %-s\n" "$user" "$pid" "$cpu" "${mem}%" "$command"
  fi
done

# =========================================
# 6. CPU FREQUENCY VÃ€ GOVERNOR
# =========================================
echo
echo "âš¡ CPU FREQUENCY:"

if [ -d "/sys/devices/system/cpu/cpu0/cpufreq" ]; then
  for cpu in /sys/devices/system/cpu/cpu[0-9]*/cpufreq; do
    if [ -d "$cpu" ]; then
      cpu_num=$(echo $cpu | grep -o '[0-9]\+' | head -1)
      current_freq=$(cat $cpu/scaling_cur_freq 2>/dev/null)
      max_freq=$(cat $cpu/cpuinfo_max_freq 2>/dev/null)
      governor=$(cat $cpu/scaling_governor 2>/dev/null)

      if [ -n "$current_freq" ]; then
        current_mhz=$((current_freq / 1000))
        max_mhz=$((max_freq / 1000))
        usage_percent=$((current_mhz * 100 / max_mhz))
        echo "ğŸ”¸ CPU$cpu_num: ${current_mhz}MHz (${usage_percent}% cá»§a ${max_mhz}MHz) - $governor"
      fi
    fi
  done
else
  echo "ğŸ”¸ KhÃ´ng cÃ³ thÃ´ng tin frequency (cÃ³ thá»ƒ Ä‘ang cháº¡y trÃªn VM)"
fi

# =========================================
# 7. INTERRUPTS VÃ€ CONTEXT SWITCHES
# =========================================
echo
echo "ğŸ”„ INTERRUPTS & CONTEXT SWITCHES:"

if [ -f /proc/stat ]; then
  interrupts=$(grep "intr" /proc/stat | awk '{print $2}')
  context_switches=$(grep "ctxt" /proc/stat | awk '{print $2}')
  processes=$(grep "processes" /proc/stat | awk '{print $2}')

  echo "ğŸ”¹ Tá»•ng interrupts: $interrupts"
  echo "ğŸ”¹ Tá»•ng context switches: $context_switches"
  echo "ğŸ”¹ Tá»•ng processes created: $processes"
fi

# =========================================
# 8. CPU TEMPERATURE
# =========================================
echo
echo "ğŸŒ¡ï¸  NHIá»†T Äá»˜ CPU:"

if command -v sensors &>/dev/null; then
  sensors 2>/dev/null | grep -E "(Core|Package|temp)" | grep -v "crit" | while read line; do
    if [[ "$line" == *"Core"* ]] || [[ "$line" == *"Package"* ]]; then
      clean_line=$(echo "$line" | sed 's/+/ /g' | cut -d'(' -f1)
      echo "ğŸ”¹ $clean_line"
    fi
  done
else
  # Kiá»ƒm tra thermal zones
  if [ -d "/sys/class/thermal" ]; then
    for zone in /sys/class/thermal/thermal_zone*/; do
      if [ -f "${zone}temp" ]; then
        temp=$(cat "${zone}temp" 2>/dev/null | awk '{print $1/1000}')
        zone_name=$(cat "${zone}type" 2>/dev/null)
        if [ -n "$temp" ] && [ "$temp" != "0.000" ]; then
          if [[ "$zone_name" == *"pkg"* ]] || [[ "$zone_name" == *"cpu"* ]] || [[ "$zone_name" == *"x86"* ]]; then
            echo "ğŸ”¹ $zone_name: ${temp}Â°C"
          fi
        fi
      fi
    done
  fi
fi

# =========================================
# 9. Tá»”NG Káº¾T
# =========================================
echo
echo "ğŸ“‹ Tá»”NG Káº¾T Há»† THá»NG:"

# Uptime
uptime_info=$(uptime -p)
echo "ğŸ”¸ Uptime: $uptime_info"

# Current users
users=$(who | wc -l)
echo "ğŸ”¸ Users Ä‘ang login: $users"

# Memory usage
mem_total=$(free -h | grep Mem: | awk '{print $2}')
mem_used=$(free -h | grep Mem: | awk '{print $3}')
mem_percent=$(free | grep Mem: | awk '{printf "%.1f", $3/$2 * 100}')
echo "ğŸ”¸ Memory: $mem_used/$mem_total (${mem_percent}%)"

# Swap usage
swap_used=$(free -h | grep Swap: | awk '{print $3}')
swap_total=$(free -h | grep Swap: | awk '{print $2}')
if [ "$swap_total" != "0B" ]; then
  swap_percent=$(free | grep Swap: | awk '{printf "%.1f", $3/$2 * 100}')
  echo "ğŸ”¸ Swap: $swap_used/$swap_total (${swap_percent}%)"
fi

echo
echo "âœ… Kiá»ƒm tra CPU hoÃ n táº¥t!"
